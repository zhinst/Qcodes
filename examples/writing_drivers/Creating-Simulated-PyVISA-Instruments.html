

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Creating Simulated PyVISA Instruments &mdash; QCoDeS 0.5.2+243.gf4ecd580c documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Logfile parsing" href="../logging/logfile_parsing.html" />
    <link rel="prev" title="Creating QCoDeS instrument drivers" href="Creating-Instrument-Drivers.html" />
    <link href="../../_static/style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> QCoDeS
          

          
          </a>

          
            
            
              <div class="version">
                0.5.2+243.gf4ecd580c
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../start/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../help.html">Get Help</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user/index.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../community/index.html">Community Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dataset/index.html">DataSet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">QCoDes API documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/generated/qcodes.instrument_drivers.html">qcodes.instrument_drivers package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changes/index.html">Changelogs</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Examples of using QCoDeS</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../index.html#basic-examples">Basic examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#parameters">Parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#dataset">DataSet</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#plotting">Plotting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#drivers">Drivers</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#writing-drivers">Writing Drivers</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="A-ParameterWithSetpoints-Example-with-Dual-Setpoints.html">A ParameterWithSetpoints Example with Dual Setpoints</a></li>
<li class="toctree-l3"><a class="reference internal" href="Creating-Instrument-Drivers.html">Creating QCoDeS instrument drivers</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Creating Simulated PyVISA Instruments</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#What?">What?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Not!">Not!</a></li>
<li class="toctree-l4"><a class="reference internal" href="#How?">How?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Example:-Weinschel_8320">Example: Weinschel_8320</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Congratulations!-That-was-it.">Congratulations! That was it.</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Bonus-example:-including-parameters-in-the-simulated-instrument">Bonus example: including parameters in the simulated instrument</a></li>
<li class="toctree-l4"><a class="reference internal" href="#That’s-it!">That’s it!</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#logging">Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#legacy-examples">Legacy examples</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">QCoDeS</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Examples of using QCoDeS</a> &raquo;</li>
        
      <li>Creating Simulated PyVISA Instruments</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/examples/writing_drivers/Creating-Simulated-PyVISA-Instruments.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 5ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="Creating-Simulated-PyVISA-Instruments">
<h1>Creating Simulated PyVISA Instruments<a class="headerlink" href="#Creating-Simulated-PyVISA-Instruments" title="Permalink to this headline">¶</a></h1>
<p>When developing stuff in a large codebase like QCoDeS, it is often uncanningly easy to submit a change that breaks stuff. Therefore, <em>continuous integration</em> is performed in the form of automated tests that run before new code is allowed into the codebase. The many tests of QCoDeS can be found in <code class="docutils literal notranslate"><span class="pre">qcodes.tests</span></code>.</p>
<p>But how about drivers? They constitute the majority of the codebase, but how can we test them? Wouldn’t that require a physical copy each instrument to be present on the California server where we run our tests? It used to be so, but not anymore! For drivers utilising PyVISA (i.e. <code class="docutils literal notranslate"><span class="pre">VisaInstrument</span></code> drivers), we may create simulated instruments to which the drivers may connect.</p>
<div class="section" id="What?">
<h2>What?<a class="headerlink" href="#What?" title="Permalink to this headline">¶</a></h2>
<p>This way, we may instantiate drivers and run simple tests on them. Tests like:</p>
<ul class="simple">
<li><p>Can the driver even instantiate? This is very relevant when underlying APIs change.</p></li>
<li><p>Is the drivers (e.g.) “voltage-to-bytecode” converter working properly?</p></li>
</ul>
</div>
<div class="section" id="Not!">
<h2>Not!<a class="headerlink" href="#Not!" title="Permalink to this headline">¶</a></h2>
<p>It is not feasible to simulate any but the most trivial features of the instrument. Simulated instruments can not and should not perform tests like:</p>
<ul class="simple">
<li><p>Do we wait sufficiently long for this oscilloscope’s trace to be acquired?</p></li>
<li><p>Does our driver handle overlapping commands of this AWG correctly?</p></li>
</ul>
</div>
<div class="section" id="How?">
<h2>How?<a class="headerlink" href="#How?" title="Permalink to this headline">¶</a></h2>
<p>The basic scheme goes as follows:</p>
<ul class="simple">
<li><p>Write a <code class="docutils literal notranslate"><span class="pre">.yaml</span></code> file for the simulated instrument. The instructions for that may be found here: <a class="reference external" href="https://pyvisa-sim.readthedocs.io/en/latest/">https://pyvisa-sim.readthedocs.io/en/latest/</a> and specifically here: <a class="reference external" href="https://pyvisa-sim.readthedocs.io/en/latest/definitions.html#definitions">https://pyvisa-sim.readthedocs.io/en/latest/definitions.html#definitions</a></p></li>
<li><p>Then write a test for your instrument and put it in <code class="docutils literal notranslate"><span class="pre">qcodes/tests/drivers</span></code>. The file should have the name <code class="docutils literal notranslate"><span class="pre">test_&lt;nameofyourdriver&gt;.py</span></code>.</p></li>
<li><p>Check that all is well by running <code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">pytest</span> <span class="pre">test_&lt;nameofyourdriver&gt;.py</span></code>.</p></li>
</ul>
<p>Below is an example.</p>
</div>
<div class="section" id="Example:-Weinschel_8320">
<h2>Example: Weinschel_8320<a class="headerlink" href="#Example:-Weinschel_8320" title="Permalink to this headline">¶</a></h2>
<p>The Weinschel 8320 is a very simple driver.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">qcodes.instrument.visa</span> <span class="k">import</span> <span class="n">VisaInstrument</span>
<span class="kn">import</span> <span class="nn">qcodes.utils.validators</span> <span class="k">as</span> <span class="nn">vals</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="k">class</span> <span class="nc">Weinschel_8320</span><span class="p">(</span><span class="n">VisaInstrument</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    QCoDeS driver for the stepped attenuator</span>
<span class="sd">    Weinschel is formerly known as Aeroflex/Weinschel</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">terminator</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="s1">&#39;attenuation&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;dB&#39;</span><span class="p">,</span>
                           <span class="n">set_cmd</span><span class="o">=</span><span class="s1">&#39;ATTN ALL </span><span class="si">{:02.0f}</span><span class="s1">&#39;</span><span class="p">,</span>
                           <span class="n">get_cmd</span><span class="o">=</span><span class="s1">&#39;ATTN? 1&#39;</span><span class="p">,</span>
                           <span class="n">vals</span><span class="o">=</span><span class="n">vals</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">60.1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()),</span>
                           <span class="n">get_parser</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">connect_message</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="The-.yaml-file">
<h3>The <code class="docutils literal notranslate"><span class="pre">.yaml</span></code> file<a class="headerlink" href="#The-.yaml-file" title="Permalink to this headline">¶</a></h3>
<p>The simplest <code class="docutils literal notranslate"><span class="pre">.yaml</span></code> file that is still useful, reads, in all its glory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">spec</span><span class="p">:</span> <span class="s2">&quot;1.0&quot;</span>
<span class="n">devices</span><span class="p">:</span>
  <span class="n">device</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">eom</span><span class="p">:</span>
      <span class="n">GPIB</span> <span class="n">INSTR</span><span class="p">:</span>
        <span class="n">q</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span>  <span class="c1"># MAKE SURE! that this matches the terminator of the driver!</span>
        <span class="n">r</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span>
    <span class="n">error</span><span class="p">:</span> <span class="n">ERROR</span>
    <span class="n">dialogues</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">q</span><span class="p">:</span> <span class="s2">&quot;*IDN?&quot;</span>
        <span class="n">r</span><span class="p">:</span> <span class="s2">&quot;QCoDeS, Weinschel 8320 (Simulated), 1337, 0.0.01&quot;</span>


<span class="n">resources</span><span class="p">:</span>
  <span class="n">GPIB</span><span class="p">::</span><span class="mi">1</span><span class="p">::</span><span class="n">INSTR</span><span class="p">:</span>
    <span class="n">device</span><span class="p">:</span> <span class="n">device</span> <span class="mi">1</span>
</pre></div>
</div>
<p>Note that since no physical connection is made, it doesn’t matter what interface we pretend to use (GPIB, USB, ethernet, serial, …). As a convention, we always write GPIB in the <code class="docutils literal notranslate"><span class="pre">.yaml</span></code> files.</p>
<p>We save the above file as <code class="docutils literal notranslate"><span class="pre">qcodes/instrument/sims/Weinschel_8320.yaml</span></code>. This simulates an instrument with no settable parameter; only an <code class="docutils literal notranslate"><span class="pre">*IDN?</span></code> response. This is enough to instantiate the instrument.</p>
<p>Then we may connect to the simulated instrument.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">qcodes.instrument.sims</span> <span class="k">as</span> <span class="nn">sims</span>
<span class="c1"># path to the .yaml file containing the simulated instrument</span>
<span class="n">visalib</span> <span class="o">=</span> <span class="n">sims</span><span class="o">.</span><span class="vm">__file__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;__init__.py&#39;</span><span class="p">,</span> <span class="s1">&#39;Weinschel_8320.yaml@sim&#39;</span><span class="p">)</span>

<span class="n">wein_sim</span> <span class="o">=</span> <span class="n">Weinschel_8320</span><span class="p">(</span><span class="s1">&#39;wein_sim&#39;</span><span class="p">,</span>
                          <span class="n">address</span><span class="o">=</span><span class="s1">&#39;GPIB::1::INSTR&#39;</span><span class="p">,</span>  <span class="c1"># This matches the address in the .yaml file</span>
                          <span class="n">visalib</span><span class="o">=</span><span class="n">visalib</span>
                          <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Connected to: QCoDeS Weinschel 8320 (Simulated) (serial:1337, firmware:0.0.01) in 0.06s
</pre></div></div>
</div>
</div>
<div class="section" id="The-test">
<h3>The test<a class="headerlink" href="#The-test" title="Permalink to this headline">¶</a></h3>
<p>Now we can write a useful test!</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">from</span> <span class="nn">qcodes.instrument_drivers.weinschel.Weinschel_8320</span> <span class="k">import</span> <span class="n">Weinschel_8320</span>
<span class="kn">import</span> <span class="nn">qcodes.instrument.sims</span> <span class="k">as</span> <span class="nn">sims</span>
<span class="n">visalib</span> <span class="o">=</span> <span class="n">sims</span><span class="o">.</span><span class="vm">__file__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;__init__.py&#39;</span><span class="p">,</span> <span class="s1">&#39;Weinschel_8320.yaml@sim&#39;</span><span class="p">)</span>


<span class="c1"># The following decorator makes the driver</span>
<span class="c1"># available to all the functions in this module</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;function&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">driver</span><span class="p">():</span>
    <span class="n">wein_sim</span> <span class="o">=</span> <span class="n">Weinschel_8320</span><span class="p">(</span><span class="s1">&#39;wein_sim&#39;</span><span class="p">,</span>
                              <span class="n">address</span><span class="o">=</span><span class="s1">&#39;GPIB::1::65535::INSTR&#39;</span><span class="p">,</span>
                              <span class="n">visalib</span><span class="o">=</span><span class="n">visalib</span>
                              <span class="p">)</span>
    <span class="k">yield</span> <span class="n">wein_sim</span>

    <span class="n">wein_sim</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">test_init</span><span class="p">(</span><span class="n">driver</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test that simple initialisation works</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># There is not that much to do, really.</span>
    <span class="c1"># We can check that the IDN string reads back correctly</span>

    <span class="n">idn_dict</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">IDN</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">idn_dict</span><span class="p">[</span><span class="s1">&#39;vendor&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;QCoDeS&#39;</span>
</pre></div>
</div>
</div>
<p>Save the test as <code class="docutils literal notranslate"><span class="pre">qcodes/tests/drivers/test_weinschel_8320.py</span></code>.</p>
<p>Open a command line/console/terminal, navigate to the <code class="docutils literal notranslate"><span class="pre">qcodes/tests/drivers/</span></code> folder and run</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;</span> <span class="n">pytest</span> <span class="n">test_weinschel_8320</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>This should give you an output similar to</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">=========================================</span> <span class="mi">1</span> <span class="n">passed</span> <span class="ow">in</span> <span class="mf">0.73</span> <span class="n">seconds</span> <span class="o">==========================================</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Congratulations!-That-was-it.">
<h2>Congratulations! That was it.<a class="headerlink" href="#Congratulations!-That-was-it." title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="Bonus-example:-including-parameters-in-the-simulated-instrument">
<h2>Bonus example: including parameters in the simulated instrument<a class="headerlink" href="#Bonus-example:-including-parameters-in-the-simulated-instrument" title="Permalink to this headline">¶</a></h2>
<p>It is also possible to add queriable parameters to the <code class="docutils literal notranslate"><span class="pre">.yaml</span></code> file, but testing that you can read those back is of limited value. You should only add them if your driver needs them to instantiate, e.g. if it checks that some range or impedance is configured correctly on startup, or - more generally - if a part of your driver code that you’d like to test needs it to run.</p>
<p>For the sake of this example, let us add a test that the driver’s parameter’s validator will reject an attenuation of less than 0 dBm. Note that this concrete test is redundant, since we have separate tests for validators. It is, however, an excellent example to learn from.</p>
<p>First we update the <code class="docutils literal notranslate"><span class="pre">.yaml</span></code> file to contain a property matching the parameter.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">spec</span><span class="p">:</span> <span class="s2">&quot;1.0&quot;</span>
<span class="n">devices</span><span class="p">:</span>
  <span class="n">device</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">eom</span><span class="p">:</span>
      <span class="n">GPIB</span> <span class="n">INSTR</span><span class="p">:</span>
        <span class="n">q</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span>  <span class="c1"># MAKE SURE! that this matches the terminator of the driver!</span>
        <span class="n">r</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span>
    <span class="n">error</span><span class="p">:</span> <span class="n">ERROR</span>
    <span class="n">dialogues</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">q</span><span class="p">:</span> <span class="s2">&quot;*IDN?&quot;</span>
        <span class="n">r</span><span class="p">:</span> <span class="s2">&quot;QCoDeS, Weinschel 8320 (Simulated), 1337, 0.0.01&quot;</span>

    <span class="n">properties</span><span class="p">:</span>

      <span class="n">attenuation</span><span class="p">:</span>
        <span class="n">default</span><span class="p">:</span> <span class="mi">0</span>
        <span class="n">getter</span><span class="p">:</span>
          <span class="n">q</span><span class="p">:</span> <span class="s2">&quot;ATTN? 1&quot;</span>  <span class="c1"># the set/get commands have to simply be copied over from the driver</span>
          <span class="n">r</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{:02.0f}</span><span class="s2">&quot;</span>
        <span class="n">setter</span><span class="p">:</span>
          <span class="n">q</span><span class="p">:</span> <span class="s2">&quot;ATTN ALL </span><span class="si">{:02.0f}</span><span class="s2">&quot;</span>

<span class="n">resources</span><span class="p">:</span>
  <span class="n">GPIB</span><span class="p">::</span><span class="mi">1</span><span class="p">::</span><span class="n">INSTR</span><span class="p">:</span>
    <span class="n">device</span><span class="p">:</span> <span class="n">device</span> <span class="mi">1</span>
</pre></div>
</div>
<p>Notice that we don’t include the the <code class="docutils literal notranslate"><span class="pre">r:</span> <span class="pre">OK</span></code> as the response of setting a property. This is in contrast to what <a class="reference external" href="https://pyvisa-sim.readthedocs.io/en/latest/definitions.html#properties">https://pyvisa-sim.readthedocs.io/en/latest/definitions.html#properties</a> does. The response of a successful setting of a parameter will not return ‘OK’.</p>
<p>Next we update the test script.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">from</span> <span class="nn">qcodes.instrument_drivers.weinschel.Weinschel_8320</span> <span class="k">import</span> <span class="n">Weinschel_8320</span>
<span class="kn">import</span> <span class="nn">qcodes.instrument.sims</span> <span class="k">as</span> <span class="nn">sims</span>
<span class="n">visalib</span> <span class="o">=</span> <span class="n">sims</span><span class="o">.</span><span class="vm">__file__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;__init__.py&#39;</span><span class="p">,</span> <span class="s1">&#39;Weinschel_8320.yaml@sim&#39;</span><span class="p">)</span>


<span class="c1"># The following decorator makes the driver</span>
<span class="c1"># available to all the functions in this module</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;function&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">driver</span><span class="p">():</span>
    <span class="n">wein_sim</span> <span class="o">=</span> <span class="n">Weinschel_8320</span><span class="p">(</span><span class="s1">&#39;wein_sim&#39;</span><span class="p">,</span>
                              <span class="n">address</span><span class="o">=</span><span class="s1">&#39;GPIB::1::INSTR&#39;</span><span class="p">,</span>
                              <span class="n">visalib</span><span class="o">=</span><span class="n">visalib</span>
                              <span class="p">)</span>
    <span class="k">yield</span> <span class="n">wein_sim</span>

    <span class="n">wein_sim</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">test_init</span><span class="p">(</span><span class="n">driver</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test that simple initialisation works</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># There is not that much to do, really.</span>
    <span class="c1"># We can check that the IDN string reads back correctly</span>

    <span class="n">idn_dict</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">IDN</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">idn_dict</span><span class="p">[</span><span class="s1">&#39;vendor&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;QCoDeS&#39;</span>


<span class="k">def</span> <span class="nf">test_attenuation_validation</span><span class="p">(</span><span class="n">driver</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test that incorrect values are rejected</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">bad_values</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">bv</span> <span class="ow">in</span> <span class="n">bad_values</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">driver</span><span class="o">.</span><span class="n">attenuation</span><span class="p">(</span><span class="n">bv</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Open a command line/console/terminal, navigate to the <code class="docutils literal notranslate"><span class="pre">qcodes/tests/drivers/</span></code> folder and run</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;</span> <span class="n">pytest</span> <span class="n">test_weinschel_8320</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>This should give you an output similar to</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">=========================================</span> <span class="mi">2</span> <span class="n">passed</span> <span class="ow">in</span> <span class="mf">0.73</span> <span class="n">seconds</span> <span class="o">==========================================</span>
</pre></div>
</div>
</div>
<div class="section" id="That’s-it!">
<h2>That’s it!<a class="headerlink" href="#That’s-it!" title="Permalink to this headline">¶</a></h2>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../logging/logfile_parsing.html" class="btn btn-neutral float-right" title="Logfile parsing" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="Creating-Instrument-Drivers.html" class="btn btn-neutral float-left" title="Creating QCoDeS instrument drivers" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>